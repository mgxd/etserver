<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Project usage</title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    </head>
    <body>
        <div class="container">
            <select name="project" id="project-select">
                <option value="" disabled selected>--Available projects--</option>
            </select>
            <input type="button" id="populate-chart" onclick="renderChart()">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <canvas id="canvas"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.2.1/dist/chart.umd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <script>
            let project = null
            const select = document.getElementById("project-select")
            const button = document.getElementById("populate-chart")

            // Query the graphql ``get_projects`` endpoint and populate the project-select
            fetch('/graphql', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    query: `{ get_projects }`
                })
            })
            .then((res) => res.json())
            .then((res) => {
                res.data.get_projects.forEach((project) => {
                    let option = document.createElement("option");
                    option.text = project;
                    select.add(option);
                });
            });

            function renderChart() {
                // destroy previous chart if still in use
                const context = document.getElementById("canvas").getContext("2d");
                let chartStatus = Chart.getChart(context);
                if (chartStatus != undefined) {
                    chartStatus.destroy();
                }

                project = select.options[select.selectedIndex].value;
                const config = {
                    type: "bar",
                    data: {
                        labels: [],  // dynamically assigned
                        datasets: [],  // dynamically assigned
                    },
                    options: {
                        plugins: {
                            title: {
                                display: true,
                                text: `${project} usage`,
                            },
                        },
                        responsive: true,
                        tooltips: {
                            mode: "index",
                            intersect: false,
                        },
                        hover: {
                            mode: "nearest",
                            intersect: true,
                        },
                        scales: {
                            x: {
                                stacked: true,
                            },
                            y: {
                                stacked: true,
                            },
                        },
                    },
                };
                const chart = new Chart(context, config);

                // populate chart config with project usage
                function get_run_data(usage) {
                    Object.keys(usage).forEach((version) => {
                        config.data.datasets.push({
                            label: version,
                            data: [
                                {x: "Total Runs", y: usage[version]["total_runs"]},
                                {x: "Successful Runs", y: usage[version]["successful_runs"]},
                                {x: "Number of Users", y: usage[version]["total_runs"]},
                            ],
                        });
                    })
                }

                // GET from data endpoint
                fetch(`/usage?project=${project}`)
                    // add catch if data retrieval fails
                    .then((res) => res.json())
                    .then((usage) => {
                        get_run_data(usage)
                        chart.update();
                    })
            };
        </script>
    </body>
</html>
