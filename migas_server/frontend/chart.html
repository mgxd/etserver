<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Project usage</title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    </head>
    <body>
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <canvas id="canvas"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.2.1/dist/chart.umd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                // const project = prompt("View usage for which project?")
                const project = "nipreps/fmriprep"
                const config = {
                    type: "bar",
                    data: {
                        labels: [],  // dynamically assigned
                        datasets: [],  // dynamically assigned
                    },
                    options: {
                        plugins: {
                            title: {
                                display: true,
                                text: `${project} usage`,
                            },
                        },
                        responsive: true,
                        tooltips: {
                            mode: "index",
                            intersect: false,
                        },
                        hover: {
                            mode: "nearest",
                            intersect: true,
                        },
                        scales: {
                            x: {
                                stacked: true,
                            },
                            y: {
                                stacked: true,
                            },
                        },
                    },
                };
                const context = document.getElementById("canvas").getContext("2d");
                const chart = new Chart(context, config);

                function get_run_data(usage) {
                    Object.keys(usage).forEach((version) => {
                        config.data.datasets.push({
                            label: version,
                            data: [
                                {x: "Total Runs", y: usage[version]["total_runs"]},
                                {x: "Successful Runs", y: usage[version]["successful_runs"]},
                                {x: "Number of Users", y: usage[version]["total_runs"]},
                            ],
                        });
                    })
                }

                // GET from data endpoint
                fetch(`/usage?project=${project}`)
                    // add catch if data retrieval fails
                    .then((response) => response.json())
                    .then((usage) => {
                        get_run_data(usage)
                        chart.update();
                    })
            }, false);
        </script>
    </body>
</html>
